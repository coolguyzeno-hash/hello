name: CI/CD Pipeline

on:
  push:
    branches: [ main, goodbye ]
  pull_request:
    branches: [ main ]

jobs:
  # HTML Validation Job
  validate-html:
    name: Validate HTML
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install HTML Validator
        run: npm install -g html-validate

      - name: Validate HTML files
        run: |
          html-validate index.html || true
          html-validate game.html || true

  # JavaScript Linting Job
  lint-javascript:
    name: Lint JavaScript
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install ESLint
        run: npm install -g eslint

      - name: Initialize ESLint config
        run: |
          cat > .eslintrc.json << 'EOF'
          {
            "env": {
              "browser": true,
              "es2021": true
            },
            "extends": "eslint:recommended",
            "parserOptions": {
              "ecmaVersion": "latest"
            },
            "rules": {
              "no-unused-vars": "warn",
              "no-undef": "warn"
            }
          }
          EOF

      - name: Lint JavaScript files
        run: |
          eslint script.js --max-warnings 10 || true
          eslint game.js --max-warnings 10 || true

  # CSS Validation Job
  validate-css:
    name: Validate CSS
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Stylelint
        run: npm install -g stylelint stylelint-config-standard

      - name: Create Stylelint config
        run: |
          cat > .stylelintrc.json << 'EOF'
          {
            "extends": "stylelint-config-standard",
            "rules": {
              "selector-class-pattern": null,
              "custom-property-pattern": null
            }
          }
          EOF

      - name: Lint CSS files
        run: |
          stylelint "**/*.css" --max-warnings 20 || true

  # Security Check Job
  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check for secrets
        run: |
          echo "Checking for potential secrets in code..."
          ! grep -r -i "api[_-]key" --include="*.js" --include="*.html" . || echo "Warning: Potential API keys found"
          ! grep -r -i "password" --include="*.js" --include="*.html" . || echo "Warning: Potential passwords found"
          ! grep -r -i "secret" --include="*.js" --include="*.html" . || echo "Warning: Potential secrets found"

  # File Size Check
  check-file-size:
    name: Check File Sizes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check file sizes
        run: |
          echo "Checking file sizes..."
          find . -type f \( -name "*.js" -o -name "*.css" -o -name "*.html" \) -exec ls -lh {} \; | awk '{if ($5 ~ /M/) print "Warning: Large file detected:", $9, $5}'
          echo "File size check complete"

  # Build and Test Job
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: [validate-html, lint-javascript, validate-css]
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Create build artifact
        run: |
          mkdir -p build
          cp index.html build/
          cp game.html build/
          cp style.css build/
          cp game.css build/
          cp script.js build/
          cp game.js build/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: game-build
          path: build/

  # Deploy to GitHub Pages
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      pages: write
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Pages
        uses: actions/configure-pages@v3

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2

  # Performance Check
  performance-check:
    name: Performance Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check for console.log
        run: |
          echo "Checking for console.log statements..."
          grep -r "console\.log" --include="*.js" . && echo "Warning: console.log found in production code" || echo "No console.log found"

      - name: Check for TODO comments
        run: |
          echo "Checking for TODO comments..."
          grep -r "TODO\|FIXME\|HACK" --include="*.js" --include="*.html" --include="*.css" . || echo "No TODO comments found"
